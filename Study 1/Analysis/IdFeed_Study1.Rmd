---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(ggeffects)
library(dplyr)
library(ggpubr)
library(grid)
library(lmerTest)
library(here)
i_am("Identity-Feedback.Rproj")
```

```{r}
library(devtools)
source_url("https://raw.githubusercontent.com/JacobElder/MiscellaneousR/master/corToOne.R")
source_url("https://raw.githubusercontent.com/JacobElder/MiscellaneousR/master/plotCommAxes.R")
```

```{r}
# fullLong1 <- data.table::fread("~/Google Drive/Volumes/Research Project/Identity Feedback/Study 1/Data/Output/id2traitDf.csv")
# orderDf1 <- data.table::fread( "~/Google Drive/Volumes/Research Project/Identity Feedback/Study 1/Data/Output/orderDf.csv")
# idShort1 <- data.table::fread( "~/Google Drive/Volumes/Research Project/Identity Feedback/Study 1/Data/Output/id2traitShort.csv")
# indDiff1 <- data.table::fread( "~/Google Drive/Volumes/Research Project/Identity Feedback/Study 1/Data/Output/indDiff.csv")
# idSim1 <- data.table::fread( "~/Google Drive/Volumes/Research Project/Identity Feedback/Study 1/Data/Output/identitySimDf.csv")

fullLong1 <- as.data.frame(arrow::read_parquet(here("Study 1","Data","id2traitDf.parquet")))
orderDf1 <- as.data.frame(arrow::read_parquet(here("Study 1","Data","orderDf.parquet")))
idShort1 <- as.data.frame(arrow::read_parquet(here("Study 1","Data","id2traitShort.parquet")))
indDiff1 <- as.data.frame(arrow::read_parquet(here("Study 1","Data","indDiff.parquet")))
idSim1 <-as.data.frame(arrow::read_parquet(here("Study 1","Data","identitySimDf.parquet")))


fullLong1$subTend <- as.numeric(fullLong1$subTend)
fullLong1$traitTend <- as.numeric(fullLong1$traitTend)
```

```{r}
# subset data for traits to only appear once per subject

traitsPerS1 <- fullLong1 %>% distinct(subID, Idx, .keep_all = TRUE)
#traitsPerS2 <- fullLong2 %>% distinct(subID, Idx, .keep_all = TRUE)

# subset data for only connected traits to appear per subject

connectDf1 <- fullLong1 %>% filter(connect==1)
#connectDf2 <- fullLong2 %>% filter(connect==1)

# convert to factors

fullLong1$connect <- as.factor(fullLong1$connect)
levels(fullLong1$connect) <- list(No  = "0", Yes = "1")

fullLong1$Condition <- as.factor(fullLong1$Condition)
levels(fullLong1$Condition) <- list(Control = "0", Feedback = "1")
idShort1$Condition <- as.factor(idShort1$Condition)
levels(idShort1$Condition) <- list(Control = "0", Feedback = "1")

#fullLong2$connect <- as.factor(fullLong2$connect)
#levels(fullLong2$connect) <- list(No  = "0", Yes = "1")

# pos neg asymmetry

idShort1$pndiff <- idShort1$pI2Tdeg - idShort1$nI2Tdeg
#idShort2$pndiff <- idShort2$pI2Tdeg - idShort2$nI2Tdeg

RaceLong <- subset(fullLong1, idcode==1)
```

# Do people self-endorse more for race connected traits?

```{r}
connect1 <- lmer(scale(selfResp) ~ connect*Condition + identity  + scale(subTend) + scale(traitTend) + ( connect | subID ) + ( 1 | traits), data=RaceLong)
summary(connect1)
connect1.plot <- ggpredict(connect1, c("Condition","connect")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Identity-Typicality") + ylab("Self-Evaluation")
connect1.plot
```

## Only looking at connected traits

```{r}
connect1 <- lmer(scale(selfResp) ~ Condition + scale(subTend) + scale(traitTend) + ( 1 | subID ) + ( 1 | traits), data=RaceLong[RaceLong$connect=="Yes",])
summary(connect1)
connect1.plot <- ggpredict(connect1, c("Condition")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Identity-Typicality") + ylab("Self-Evaluation")
connect1.plot
```

## Only looking at connected traits, moderated by valence

```{r}
connect1 <- lmer(scale(selfResp) ~ Condition*valence + scale(subTend) + scale(traitTend) + ( valence | subID ) + ( 1 | traits), data=RaceLong[RaceLong$connect=="Yes",])
summary(connect1)
connect1.plot <- ggpredict(connect1, c("Condition","valence")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Condition") + ylab("Self-Evaluation")
connect1.plot
```

## Only looking at connected traits, moderated by valence and positivity of identity

```{r}
connect1 <- lmer(scale(selfResp) ~ Condition*scale(pos)*valence + scale(subTend) + scale(traitTend) + ( scale(pos) + valence | subID ) + ( 1 | traits), data=RaceLong[RaceLong$connect=="Yes",])
summary(connect1)
connect1.plot <- ggpredict(connect1, c("pos","Condition","valence")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Identity-Typicality") + ylab("Self-Evaluation")
connect1.plot
```
## Only looking at connected traits, moderated by valence and strength of identification

```{r}
connect1 <- lmer(scale(selfResp) ~ Condition*scale(streng)*valence + scale(subTend) + scale(traitTend) + ( scale(streng) + valence | subID ) + ( 1 | traits), data=RaceLong[RaceLong$connect=="Yes",])
summary(connect1)
connect1.plot <- ggpredict(connect1, c("streng","Condition","valence")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Strength of Identification") + ylab("Self-Evaluation")
connect1.plot
```

### Does it depend on valence?

```{r}
connectval1 <- lmer(scale(selfResp) ~ connect*Condition*valence + scale(subTend) + scale(traitTend) + ( connect + valence | subID ) + ( 1 | traits), data=RaceLong)
summary(connectval1)
connectval1.plot <- ggpredict(connectval1, c("connect","valence","Condition")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Identity Typicality") + ylab("Self-Evaluation")
connectval1.plot
```

```{r}
connect1 <- lmer(scale(selfResp) ~ idDistRaceN*connect*Condition + scale(subTend) + scale(traitTend) + ( connect + idDistRaceN | subID / id ) + ( 1 | traits), data=fullLong1)
summary(connect1)
connect1.plot <- ggpredict(connect1, c("idDistRaceN","connect","Condition")) %>% plot(show.title=FALSE) + jtools::theme_apa() + xlab("Distance from Racial Identity") + ylab("Self-Evaluation")
connect1.plot
```

# Self-endorsing identity-typical traits leads to greater identification/perceived positivity?

```{r}
RaceLong$connectn <- as.numeric(RaceLong$connect)-1
summarized <- Rmisc::summarySE(data=RaceLong, measurevar = "selfResp", groupvars = c("subID","connect"))

summarized<-tidyr::pivot_wider(summarized, id_cols="subID", values_from="selfResp",names_from="connect")
# 
# summarized <- merge(summarized, indDiff1, by="subID")

RaceShort <- RaceLong[match(unique(RaceLong$subID), RaceLong$subID),]

summarized <- merge(summarized, RaceShort, by="subID")

# more self-descriptive on race-connected relative to race-unconnected traits
summarized$diff <- summarized$Yes-summarized$No

m <- lm(diff ~ Condition * pos, data=summarized)
summary(m)
ggpredict(m, c("pos","Condition")) %>% plot(show.title=FALSE) 

m <- lm(inclus ~ Condition * diff, data=summarized)
summary(m)

m <- lm(streng ~ Condition * diff, data=summarized)
summary(m)

m <- lm((SE.T2-SE.T1) ~ Condition * diff, data=summarized)
summary(m)

summarized$MGIS.Diff <- (summarized$MGIS.T2-summarized$MGIS.T1)
m <- lm(MGIS.Diff ~ Condition * diff, data=summarized)
summary(m)
ggpredict(m, c("diff","Condition")) %>% plot(show.title=FALSE) 
ggpredict(m, c("Condition")) %>% plot(show.title=FALSE) 

m <- lm((PANAS_Pos.T2-PANAS_Pos.T1) ~ Condition * diff, data=summarized)
summary(m)

m <- lm((PANAS_Neg.T2-PANAS_Neg.T1) ~ Condition * diff, data=summarized)
summary(m)
```

# Does negative feedback propagate to influence perceived positivity of connected identities?

```{r}
connect2 <- lmer(scale(pos) ~ Condition * idCommRaceN + ( idCommRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idCommRaceN","Condition")) %>% plot(show.title=FALSE) 

connect2 <- lmer(scale(stig) ~ Condition * idCommRaceN + ( idCommRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idCommRaceN","Condition")) %>% plot(show.title=FALSE)

connect2 <- lmer(scale(streng) ~ Condition * idCommRaceN + ( idCommRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idCommRaceN","Condition")) %>% plot(show.title=FALSE)
```

## Exploratory Identity Propagation Models

```{r}
connect2 <- lmer(scale(streng) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 

connect2 <- lmer(scale(sizeS) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 

connect2 <- lmer(scale(sizeU) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 

connect2 <- lmer(scale(inclus) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 

connect2 <- lmer(scale(differ) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=idShort1)
summary(connect2)
ggpredict(connect2, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 
```

# Does feedback propagate to influence self-descriptiveness for identity connected vs. non identity connected traits?

Self-descriptiveness of connected relative to non-connected traits... As you get farther from the racial identity, connected traits become less self-descriptive.

```{r}
fullLong1$connectn <- as.numeric(fullLong1$connect)-1
summarized <- Rmisc::summarySE(data=fullLong1, measurevar = "selfResp", groupvars = c("subID","idcode","connect"), na.rm=T)

summarized<-tidyr::pivot_wider(summarized, id_cols=c("subID","idcode"), values_from="selfResp",names_from="connect")

shortened <- fullLong1[match(unique(fullLong1$subID), fullLong1$subID),]

summarized <- merge(summarized, idShort1, by=c("subID","idcode"))

summarized$diff <- summarized$Yes-summarized$No

endorseprop <- lmer(scale(diff) ~ Condition * idDistRaceN + ( idDistRaceN | subID ) + ( 1 | idcode), data=summarized)
summary(endorseprop)
ggpredict(endorseprop, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 


endorseprop <- lmer(scale(diff) ~ Condition * scale(idCommRaceN) + ( scale(idCommRaceN) | subID ) + ( 1 | idcode), data=summarized)
summary(endorseprop)
ggpredict(endorseprop, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 
```

# Does identity spillover to shape self-descriptiveness for connected identities and traits?

Traits connected to racial identity are evaluated more self-descriptively that non-connected traits.

```{r}
fullLong1$raceyn <- ifelse(fullLong1$idcode==1, "Racial", "Not")
connect1 <- lmer(scale(selfResp) ~ raceyn*connect*Condition + scale(subTend) + scale(traitTend) + ( connect + raceyn | subID ) + ( 1 | traits), data=fullLong1)
summary(connect1)
ggpredict(connect1, c("Condition","raceyn","connect")) %>% plot(show.title=FALSE) 
```

```{r}
# Fill in other analyses here
```

# Feedback influences self-views for identities more overlapping with affected racial identity?

Self-evaluations for identities farther from 

```{r}
connectedLong <- subset(fullLong1, connect == "Yes")
connect1 <- lmer(scale(selfResp) ~ scale(idDistRaceN)*Condition + scale(subTend) + scale(traitTend) + ( scale(idDistRaceNW)  | subID ) + ( 1 | traits), data=connectedLong)
summary(connect1)
ggpredict(connect1, c("idDistRaceN","Condition")) %>% plot(show.title=FALSE) 
```

# Depends on valence?

```{r}
connect1 <- lmer(scale(selfResp) ~ scale(idDistRaceN)*Condition*valence + scale(subTend) + scale(traitTend) + ( valence + scale(idDistRaceNW)  | subID ) + ( 1 | traits), data=connectedLong)
summary(connect1)
ggpredict(connect1, c("idDistRaceNW","Condition","valence")) %>% plot(show.title=FALSE) 
```

## Depends on overlap between identities?

```{r}
connect1 <- lmer(scale(selfResp) ~ scale(idDistRaceNW)*Condition*overlap_norm + scale(subTend) + scale(traitTend) + ( overlap_norm + scale(idDistRaceNW)  | subID ) + ( 1 | traits), data=connectedLong)
summary(connect1)
ggpredict(connect1, c("idDistRaceNW","Condition","overlap_norm")) %>% plot(show.title=FALSE) 
```

## Depends on strength of perceived positivity of identity?

```{r}
connect1 <- lmer(scale(selfResp) ~ scale(idDistRaceN)*Condition*pos + scale(subTend) + scale(traitTend) + ( scale(idDistRaceNW)  | subID ) + ( 1 | traits), data=connectedLong)
summary(connect1)
ggpredict(connect1, c("idDistRaceNW","Condition","overlap_norm")) %>% plot(show.title=FALSE) 
```

```{r}
connect1 <- lmer(scale(selfResp) ~ scale(idDistRaceN)*Condition*valence + scale(subTend) + scale(traitTend) + ( scale(idDistRaceN) + valence  | subID ) + ( 1 | traits), data=connectedLong)
summary(connect1)
```

# Similarity Analyses

```{r}
sim.m1 <- lmer(scale(strengDist) ~ scale(idSim)*Condition + ( scale(idSim) | subID ), data=idSim1)
summary(sim.m1)
```

```{r}
sim.m1 <- lmer(scale(strengDist) ~ scale(idSim)*Condition*raceConn + ( scale(idSim) | subID ), data=idSim1)
summary(sim.m1)
ggpredict(sim.m1, c("idSim","Condition","raceConn")) %>% plot(show.title=FALSE) 
```

$

```{r}
dist.m1 <- lmer(scale(selfResp) ~ scale(order)*Condition + ( scale(order) | subID ) + (1 | traits), data=orderDf1)
summary(dist.m1)
```

```{r}
raceOrder <- subset(orderDf1, idq == identity)
dist.m1 <- lmer(scale(selfResp) ~ scale(IT.Sim)*Condition + ( scale(order) | subID ) + (1 | traits), data=raceOrder)
summary(dist.m1)
ggpredict(dist.m1, c("IT.Sim","Condition")) %>% plot(show.title=FALSE) 
```


